<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=0">
    <title>${blogName!}陆英杰的博客</title>
    <meta name="author" content="陆英杰,luyingjie">
    <meta name="keywords" content="java,陆英杰,陆英杰的博客,luyingjie,${headers!}"/>
    <meta name="description" content="${description!}">

    <!-- import element CSS -->
    <link href="https://cdn.bootcss.com/element-ui/2.12.0/theme-chalk/index.css" rel="stylesheet">
    <!-- import github-markdown CSS -->
    <link href="https://cdn.bootcss.com/github-markdown-css/3.0.1/github-markdown.min.css" rel="stylesheet">
    <!-- import 代码高亮 CSS -->
    <link href="https://cdn.bootcss.com/prism/1.17.1/themes/prism-solarizedlight.min.css" rel="stylesheet">
<!--    <link href="https://cdn.bootcss.com/prism/1.17.1/themes/prism.min.css" rel="stylesheet">-->
    <!-- import 代码行号 CSS -->
    <link href="https://cdn.bootcss.com/prism/1.17.1/plugins/line-numbers/prism-line-numbers.min.css" rel="stylesheet">
    <!-- import 代码块工具条 CSS -->
    <link href="https://cdn.bootcss.com/prism/1.17.1/plugins/toolbar/prism-toolbar.min.css" rel="stylesheet">
    <!-- import header CSS -->
    <link href="/header.css" rel="stylesheet">
    <!-- import element-user CSS -->
    <link href="/element.css" rel="stylesheet">
    <!-- import code CSS -->
    <link href="/code.css" rel="stylesheet">
</head>

<body>
    <div id="app" class="top-body" v-cloak>

        <el-row type="flex" justify="space-between">
            <el-col :xs="24" :span="12">
                    <el-breadcrumb>
                        <el-breadcrumb-item>
                            <el-link href="/dirSearch">目录</el-link>
                        </el-breadcrumb-item>
                        <el-breadcrumb-item v-for="item in pathArr">
                            <el-link :href="item.url">{{item.value}}</el-link>
                        </el-breadcrumb-item>
                    </el-breadcrumb>
            </el-col>
            <el-col :xs="0" :span="1" style="min-width: 150px">
                <el-breadcrumb separator="|">
                    <el-breadcrumb-item>
                        <el-link href="/">首页</el-link>
                    </el-breadcrumb-item>
                    <el-breadcrumb-item>
                        <el-link @click="outline_drawer=true">大纲</el-link>
                    </el-breadcrumb-item>
                    <el-breadcrumb-item>
                        <el-link @click="dir_drawer=true">搜索</el-link>
                    </el-breadcrumb-item>
                </el-breadcrumb>
            </el-col>
        </el-row>

        <el-row style="margin: 15px 0px;">
            <el-col :span="24">
                <el-link type="info" :underline="false">阅读：${visitTimes!'0'}</el-link>
            </el-col>
        </el-row>

        <!--导航-->
        <el-drawer
                id="header"
                title="导航"
                :visible.sync="outline_drawer"
                direction="ltr"
                :modal="true"
                @opened="focus_outline"
                :size="outline_size">

            <el-tabs type="border-card" :stretch="true" @tab-click="focus_outline" v-model="outline_tab_active_value">
                <!--大纲-->
                <el-tab-pane label="大纲">
                    <el-input id="headerSearchInput" v-model="headerSearchInput" clearable placeholder="搜索大纲" @input="headerSearch"></el-input>
                    <el-link v-for="(item,index) in headerData"
                             :key="index"
                             :class="'header side-header'+item.levle"
                             :href="'#'+item.value"
                             :underline="false"
                             :type="item.label.indexOf('（***）')==-1?'default':'danger'">
                        {{ item.label.indexOf('（***）')==-1?item.label:item.label.substring(0,item.label.length-5) }}
                    </el-link>
                </el-tab-pane>
                <!--目录-->
                <el-tab-pane label="目录">
                    <el-input
                            id="filterDirText"
                            placeholder="输入关键字进行过滤"
                            v-model="filterDirText">
                    </el-input>
                    <el-tree
                            class="filter-tree"
                            :data="dirData"
                            :props="defaultDirProps"
                            default-expand-all
                            :expand-on-click-node="false"
                            :filter-node-method="filterNode"
                            @node-click="handleNodeClick"
                            ref="tree">
                    </el-tree>
                </el-tab-pane>
            </el-tabs>
        </el-drawer>

        <!--全能搜索-->
        <el-drawer
                    title="全能搜索"
                    direction="rtl"
                    :visible.sync="dir_drawer"
                    @opened="focus_search"
                    :size="dir_size">

                <el-tabs type="border-card" :stretch="true" @tab-click="focus_search" v-model="search_tab_active_value">
                    <!--搜索全部-->
                    <el-tab-pane label="搜索全部">
                        <el-input id="searchAllInput" v-model="searchAllInput" clearable placeholder="搜索所有内容" @input="searchAll"></el-input>
                        <div v-for="item in searchAllData" >
                            <el-link :underline="false" :href="'/blog'+item.sourceAsMap.blogId+'#'+item.sourceAsMap.headerName" style="display: block">
                                {{item.sourceAsMap.blogName}}：{{item.sourceAsMap.headerName}}
                            </el-link>

                            <el-link type="info" :underline="false" style="display: block" :href="'/blog'+item.sourceAsMap.blogId+'#'+item.sourceAsMap.headerName">
                                {{item.sourceAsMap.headerContent.length>200?item.sourceAsMap.headerContent.substring(0,100):item.sourceAsMap.headerContent}}
                            </el-link>
                            <el-divider></el-divider>
                        </div>
                        <div style="text-align: center;margin-top: 10px">
                            <el-button size="small" @click="searchAllMore(searchAllPage++)" v-show="searchAllHasMoreFlag">加载更多</el-button>
                            <el-button size="small" disabled v-show="!searchAllHasMoreFlag">无更多数据</el-button>
                        </div>
                    </el-tab-pane>
                    <!--搜索所有标题-->
                    <el-tab-pane label="搜索所有标题">
                        <el-input id="searchAllHeaderInput" v-model="searchAllHeaderInput" clearable placeholder="搜索所有标题" @input="searchAllHeader"></el-input>
                        <div v-for="item in searchAllHeaderData">
                            <el-link :underline="false" :href="'/blog'+item.sourceAsMap.blogId+'#'+item.sourceAsMap.headerName" style="display: block">
                                {{item.sourceAsMap.headerName}}
                            </el-link>
                            <el-link type="info" :underline="false" style="display: block" :href="'/blog'+item.sourceAsMap.blogId+'#'+item.sourceAsMap.headerName">{{item.sourceAsMap.blogId}}</el-link>
                            <el-divider></el-divider>
                        </div>
                        <div style="text-align: center;margin-top: 10px">
                            <el-button size="small" @click="searchAllHeaderMore(searchAllHeaderPage++)" v-show="searchAllHeaderHasMoreFlag">加载更多</el-button>
                            <el-button size="small" disabled v-show="!searchAllHeaderHasMoreFlag">无更多数据</el-button>
                        </div>
                    </el-tab-pane>

                </el-tabs>

            </el-drawer>

    </div>

    <!-- 博客内容（避免被vue解析） -->
    <div id="blog" class="markdown-body">
        ${blog!}
    </div>

    <!-- 用于blogName的复制 -->
    <input id="blogName" style="display: none" value="editnote ${blogName!}" />

    <!-- 工信部备案号 -->
    <div style="text-align: center">
        <a href="http://www.beian.miit.gov.cn" style="color: #767676;text-decoration: none;">ICP证 : 浙ICP备18021271号</a>
    </div>
</body>
<!--vue.js-->
<script src="https://cdn.bootcss.com/vue/2.6.10/vue.min.js"></script>
<!--<script src="https://cdn.bootcss.com/vue/2.6.10/vue.common.dev.js"></script>&lt;!&ndash;开发的时候使用生产模式&ndash;&gt;-->
<!--axios.js-->
<script src="https://cdn.bootcss.com/axios/0.19.0-beta.1/axios.min.js"></script>
<!--element.js-->
<script src="https://cdn.bootcss.com/element-ui/2.12.0/index.js"></script>
<!--代码高亮js-->
<script src="https://cdn.bootcss.com/prism/1.17.1/components/prism-core.min.js"></script>
<script src="https://cdn.bootcss.com/prism/1.17.1/plugins/autoloader/prism-autoloader.min.js"></script>
<!--代码行号js-->
<script src="https://cdn.bootcss.com/prism/1.17.1/plugins/line-numbers/prism-line-numbers.min.js"></script>
<!--代码工具条js-->
<script src="https://cdn.bootcss.com/prism/1.17.1/plugins/toolbar/prism-toolbar.min.js"></script>
<!--代码复制js-->
<script src="https://cdn.bootcss.com/prism/1.17.1/plugins/copy-to-clipboard/prism-copy-to-clipboard.min.js"></script>
<script>
    //全局快捷键
    var q_key=81;
    var Q_key=113;
    var w_key=87;
    var W_key=119;
    var c_key=67;
    var C_key=99;
    var a_key=65;
    var A_key=97;
    document.onkeypress=function (event) {
        var key = event.keyCode;

        console.log(key,event.shiftKey,event.altKey,event.ctrlKey)
        if(event.shiftKey && (key==q_key || key==Q_key)){
            vue.outline_drawer=!vue.outline_drawer;
            event.preventDefault();//阻止默认事件
        }else if(event.shiftKey && (key==w_key || key==W_key)){
            vue.dir_drawer=!vue.dir_drawer;
            event.preventDefault();//阻止默认事件
        }else if(event.shiftKey && (key==a_key || key==A_key)){
            window.location="/dirSearch";
        }else if(event.shiftKey && (key==c_key || key==C_key)){
            //将笔记的名称保存到剪贴板中
            var blogName=document.getElementById("blogName");
            blogName.style.display='block';//只有先显示出来，才能够复制内容
            blogName.select();// 选择对象并选中
            document.execCommand("copy");// 执行浏览器复制命令
            blogName.style.display='none';//隐藏input输入框
        }
    }

    var vue=new Vue({
        el: '#app',
        data: {
            isMobile:window.innerWidth<576,

            //outline
            headerSearchInput:"",
            headerData:[],
            headerBuff:[],
            outline_drawer: false,
            outline_tab_active_value:"",//导航栏激活的标签名称
            outline_size: window.innerWidth<576==true?'70%':'20%',

            //dir
            filterDirText:"",
            defaultDirProps: {
                children: 'child',
                label: 'name',
                value:'url'
            },
            dirData:${dirData!''},
            dir_drawer: false,
            dir_size: window.innerWidth<576==true?'70%':'30%',

            //面包屑
            pathArr: [],

            //search-header
            searchAllHeaderInput:"",
            searchAllHeaderData:[],
            searchAllHeaderPage:0,
            searchAllHeaderHasMoreFlag:false,//是否还有更多数据的标志

            //search-all
            searchAllInput:"",
            searchAllData:[],
            searchAllPage:0,
            searchAllHasMoreFlag:false,//是否还有更多数据的标志
            search_tab_active_value:"",//搜索栏激活的标签名称

            delay_time:250,//防抖250ms

        },
        watch: {
            //导航栏中目录过滤
            filterDirText(val) {
                this.$refs.tree.filter(val);
            }
        },
        created:function(){
            var _this=this;
            //获取header数据,并保存到headerBuff和headerData中
            var headers=document.getElementsByClassName("header");
            for(var i=0;i<headers.length;i++){
                var header=headers[i];
                //添加标题搜索数据
                _this.headerData.push({
                    value:header.textContent,
                    label:header.textContent,
                    levle:header.tagName.charAt(1)
                });
                _this.headerBuff=_this.headerData;//保存一份数据
            }
            //获取面包屑数据
            var path=decodeURI(window.location.pathname);
            var arr=path.substring(6).split("/");
            for(var i=0;i<arr.length;i++){
                var item=arr[i];
                var buff="/dirSearch/"+item;
                //最后一个不需要生成链接
                if(i==arr.length-1){
                    buff="javascrpit:void(0);";
                }
                this.pathArr.push({
                    value:item,
                    url:buff
                });
            }

        },
        methods:{
            //大纲搜索
            headerSearch:debounce(function () {
                if(this.headerSearchInput!=""){
                    this.headerData=[];
                    this.headerBuff.map(item=>{
                        if(item.label.toLowerCase().indexOf(this.headerSearchInput.toLowerCase())!=-1){
                            this.headerData.push(item);
                        }
                    })
                }else{
                    this.headerData=this.headerBuff;
                }
            },this.delay_time),
            //搜索全部header
            searchAllHeader:debounce(function () {
                this.searchAllHeaderPage=0;//页数清空
                this._searchAllHeader();
            },this.delay_time),
            //查询allHeader的数据
            _searchAllHeader(){
                var _this=this;
                if(this.searchAllHeaderInput!=""){
                    var url='/searchAllHeader?keyword='+this.searchAllHeaderInput+"&page="+this.searchAllHeaderPage;

                    //查询所有header
                    axios.get(url)
                        .then(function (response) {
                            console.log(response.data)
                            if(_this.searchAllHeaderPage==0){
                                _this.searchAllHeaderData=response.data;//不是查看更多则直接赋值
                            }else{
                                response.data.map(item=>{_this.searchAllHeaderData.push(item)})
                            }
                            //标记是否还有数据
                            if(response.data.length>=20){
                                _this.searchAllHeaderHasMoreFlag=true;
                            }else{
                                _this.searchAllHeaderHasMoreFlag=false;
                            }
                        });
                }else{
                    this.searchAllHeaderData=[];
                    this.searchAllHeaderHasMoreFlag=false;
                }
            },
            //全局搜索
            //查询所有内容
            searchAll:debounce(function () {
                this.searchAllPage=0;//页数清空
                this._searchAll();
            },this.delay_time),
            _searchAll(){
                var _this=this;
                if(this.searchAllInput!=""){
                    var url='/searchAll?keyword='+this.searchAllInput+"&page="+this.searchAllPage;

                    //查询所有
                    axios.get(url)
                        .then(function (response) {
                            console.log(response.data)
                            if(_this.searchAllPage==0){
                                _this.searchAllData=response.data;//不是查看更多则直接赋值
                            }else{
                                response.data.map(item=>{_this.searchAllData.push(item)})
                            }
                            //标记是否还有数据
                            if(response.data.length>=20){
                                _this.searchAllHasMoreFlag=true;
                            }else{
                                _this.searchAlHeaderHasMoreFlag=false;
                            }
                        });
                }else{
                    this.searchAllData=[];
                    this.searchAllHasMoreFlag=false;
                }
            },
            //导航栏中目录过滤
            filterNode(value, data) {
                if (!value) return true;
                return data.name.toLowerCase().indexOf(value.toLowerCase()) !== -1;
            },
            //导航栏中目录点击
            handleNodeClick(data,node,nodes) {
                if(node.isLeaf){
                    window.location="/blog"+data.url;
                }
            },
            searchAllMore(page){
                console.log(page)
                this._searchAll();
            },
            //加载更多
            searchAllHeaderMore(page){
                console.log(page)
                //在点击加载更多时，页数自动增加
                this._searchAllHeader();
            },
            //根据标签页使得对应输入框获取焦点
            focus_outline(){
                //手机不聚焦
                if(this.isMobile){
                    return;
                }
                if(this.outline_tab_active_value=="0"){
                    setTimeout(function () {
                        document.getElementById("headerSearchInput").focus();
                    },150)
                }else{
                    setTimeout(function () {
                        document.getElementById("filterDirText").focus();
                    },150)
                }
            },
            //根据标签页使得对应输入框获取焦点
            focus_search(){
                //手机不聚焦
                if(this.isMobile){
                    return;
                }
                if(this.search_tab_active_value=="0"){
                    setTimeout(function () {
                        document.getElementById("searchAllInput").focus();
                    },150)
                }else{
                    setTimeout(function () {
                        document.getElementById("searchAllHeaderInput").focus();
                    },150)
                }
            }
            
        }

    })


    //限流函数
    function debounce(func, wait) {
        // wait：500ms；func：被频繁触发的事件
        let timeout;
        return function () {
            let context = this;
            let args = arguments;
            let later = () => {
                timeout = null;
                func.apply(context, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        }
    }


    //手机端工具类
    const DomUtils={
        isMobile(){
            return window.innerWidth<576;
        },
        addGestureEvent(callback){
            let startPoint=null,endPoint=null;
            var arr=["TD","TH","PRE","SPAN","CODE"];//遇到这些元素不执行滑动操作
            document.addEventListener("touchstart",function (event) {
                let touch = event.targetTouches[0];
                startPoint={
                    x:touch.clientX,
                    y:touch.clientY
                };
            });
            document.addEventListener("touchend",function (event) {
                // console.log(event.target.tagName)

                //防止其他有滚动条的元素扰乱滑动监听
                for(var i=0;i<arr.length;i++){
                    if(event.target.tagName===arr[i]){
                        return;
                    }
                }

                let touch = event.changedTouches[0];
                endPoint={
                    x:touch.clientX,
                    y:touch.clientY
                };
                //计算手势
                let xDistance=endPoint.x-startPoint.x;
                let yDistance=endPoint.y-startPoint.y;
                if(Math.abs(xDistance)>Math.abs(yDistance)){
                    if(Math.abs(xDistance)>window.innerWidth*(1/5.0)){
                        callback(xDistance>0?"right":"left");
                    }
                }else{
                    if(Math.abs(yDistance)>window.innerHeight*(1/3.0)){
                        callback(yDistance>0?"down":"top");
                    }
                }
            })
        }
    }


    //手机端监听左右滑动事件
    if(DomUtils.isMobile()){
        DomUtils.addGestureEvent(function (event) {
            if(event==="right"){
                vue.outline_drawer=true;
            }else if(event==="left"){
                vue.dir_drawer=true;
            }
        })
    }

    //懒加载图片
    window.onload = function() {
        var imgs=document.getElementsByTagName("img");
        for(var i=0;i<imgs.length;i++){
            var img=imgs[i];
            if(img.attributes.length!=0){
                img.src=window.location.origin+img.attributes.buff.value;
            }
        }
    };
</script>

<!--SEO-->
<div style="display: none">
    ${SEOData!}
</div>
</html>